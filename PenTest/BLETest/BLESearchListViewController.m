//
//  BLESearchListViewController.m
//  PenTestExtension
//
//  Created by Luidia on 2018. 05. 04..
//  Copyright © 2018년 Luidia. All rights reserved.
//

#import "BLESearchListViewController.h"

@interface BLESearchListViewController () <UITableViewDelegate, UITableViewDataSource>
{
    IBOutlet UITableView *tableView;
}
@end

@implementation BLESearchListViewController
@synthesize m_frame;
@synthesize deviceList;
@synthesize delegate;

- (void)dealloc
{
    if (tableView){
        [tableView release];
        tableView = nil;
    }
    
    if (self.deviceList) {
        [self.deviceList removeAllObjects];
        self.deviceList = nil;
    }
    
    [super dealloc];
}

-(id) initWithNibName:(NSString *)nib bundle:(NSBundle *)nibNameOrNil
{
    self = [super initWithNibName:nib bundle:nibNameOrNil];
    if (self) {
        delegate = nil;
        self.deviceList = [[[NSMutableArray alloc] init] autorelease];
    }
    return self;
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    self.view.frame = self.m_frame;
    tableView.delegate = self;
    tableView.dataSource = self;
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (IBAction)closeClicked:(id)sender {
    if (delegate) {
        if ([self.delegate respondsToSelector:@selector(closeBLESearchListViewController)]) {
            [self.delegate closeBLESearchListViewController];
        }
    }
    else
        [self dismissViewControllerAnimated:YES completion:^{}];
}

-(void) refresh {
    [tableView reloadData];
}

- (IBAction)selectClicked:(id)sender {
    int idx = (int)[tableView indexPathForSelectedRow].row;
    if (idx == -1)
        return;
    if (self.deviceList.count == 0)
        return;
    if (self.deviceList.count <= idx)
        return;
    
    
    CBPeripheral* peripheral = [[self.deviceList objectAtIndex:idx] objectForKey:@"peripheral"];
    
    if (delegate) {
        if ([self.delegate respondsToSelector:@selector(selectBLEDevice:)]) {
            [self.delegate selectBLEDevice:peripheral];
        }
    }
}



- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {
    return 1;
}
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return self.deviceList.count;
}
- (UITableViewCell *)tableView:(UITableView *)tv cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    NSString *CellIdentifier = [NSString stringWithFormat:@"Cell%d%d", (int)indexPath.section, (int)indexPath.row];
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:CellIdentifier];
    if (cell == nil) {
        cell = [[[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:CellIdentifier]autorelease];
    }
    [[cell.contentView subviews] makeObjectsPerformSelector:@selector(removeFromSuperview)];
    cell.backgroundColor = [UIColor whiteColor];
    
    NSDictionary* advertisementData = [[self.deviceList objectAtIndex:indexPath.row] objectForKey:@"advertisementData"];
    NSString *localName = [advertisementData objectForKey:CBAdvertisementDataLocalNameKey];
    if (localName == nil || [localName isEqualToString:@""]) {
        CBPeripheral* peripheral = [[self.deviceList objectAtIndex:indexPath.row] objectAtIndex:0];
        localName = peripheral.name;
    }

    [cell.textLabel setText:localName];
    
    return cell;
}
@end
